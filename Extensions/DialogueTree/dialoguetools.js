var gdjs;(function(e){const n=new e.Logger("Dialogue tree");e.dialogueTree={},e.dialogueTree.runner=new bondage.Runner,e.dialogueTree.loadFromSceneVariable=function(i,t){this.runner=e.dialogueTree.runner;try{this.yarnData=JSON.parse(i.getAsString()),this.runner.load(this.yarnData),t&&t.length>0&&e.dialogueTree.startFrom(t)}catch(a){n.error("Error while loading from scene variable: ",a)}},e.dialogueTree.loadFromJsonFile=function(i,t,a){i.getGame().getJsonManager().loadJson(t,function(s,r){if(s)n.error("An error happened while loading JSON resource:",s);else{if(!r)return;e.dialogueTree.yarnData=r;try{e.dialogueTree.runner.load(e.dialogueTree.yarnData)}catch(o){n.error("An error happened while loading parsing the dialogue tree data:",o)}a&&a.length>0&&e.dialogueTree.startFrom(a)}})},e.dialogueTree.stopRunningDialogue=function(){this.dialogueIsRunning&&(this.dialogueIsRunning=!1),this.dialogueData&&(this.dialogueData=null),this.dialogueText="",this.clipTextEnd=0},e.dialogueTree.isRunning=function(){return this.dialogueIsRunning&&!this.dialogueData&&this.dialogueText&&this.clipTextEnd>=this.dialogueText.length&&(this.dialogueIsRunning=!1),this.dialogueIsRunning},e.dialogueTree.scrollClippedText=function(){if(!(this.pauseScrolling||!this.dialogueIsRunning)){if(e.dialogueTree._isLineTypeCommand()&&this.dialogueDataType==="text"&&this.dialogueBranchTitle===this.dialogueData.data.title&&this.lineNum===this.dialogueData.lineNum&&e.dialogueTree.hasClippedScrollingCompleted()){e.dialogueTree.goToNextDialogueLine();return}this.dialogueText&&this.dialogueDataType==="text"&&this.clipTextEnd<this.dialogueText.length&&(this.clipTextEnd+=1)}},e.dialogueTree.completeClippedTextScrolling=function(){this.pauseScrolling||!this.dialogueIsRunning||!this.dialogueText||this.dialogueDataType!=="text"||(this.clipTextEnd=this.dialogueText.length)},e.dialogueTree.hasClippedScrollingCompleted=function(){return!this.dialogueIsRunning||this.dialogueDataType===""?!1:this.dialogueData&&this.dialogueText.length>0&&this.clipTextEnd>=this.dialogueText.length?(e.dialogueTree.getVariable("debug")&&n.warn("Scroll completed:",this.clipTextEnd,"/",this.dialogueText.length),!0):!1},e.dialogueTree.getClippedLineText=function(){return this.dialogueIsRunning&&this.dialogueText.length?this.dialogueText.substring(0,this.clipTextEnd+1):""},e.dialogueTree.getLineText=function(){return this.dialogueIsRunning&&this.dialogueText.length?this.dialogueText:""},e.dialogueTree.commandParametersCount=function(){return this.commandParameters&&this.commandParameters.length>1?this.commandParameters.length-1:0},e.dialogueTree.getCommandParameter=function(i){if(i===-1&&this.commandParameters.length>0)return this.commandParameters[0];if(this.commandParameters&&this.commandParameters.length>=i+1){const t=this.commandParameters[i+1];return t||""}return""},e.dialogueTree.isCommandCalled=function(i){if(!this.dialogueIsRunning)return!1;const t=e.dialogueTree.commandCalls,a=e.dialogueTree.clipTextEnd,s=e.dialogueTree.dialogueText;return this.pauseScrolling||!t?!1:this.commandCalls.some(function(r,o){if(a!==0&&a<r.time)return!1;if(r.cmd==="wait"&&(a===0||a!==s.length)&&(e.dialogueTree.pauseScrolling=!0,setTimeout(function(){e.dialogueTree.pauseScrolling=!1,t.splice(o,1),e.dialogueTree.getVariable("debug")&&n.info("CMD:",r)},parseInt(r.params[1],10))),r.cmd===i)return e.dialogueTree.commandParameters=r.params,t.splice(o,1),e.dialogueTree.getVariable("debug")&&n.info("CMD:",r),!0})},e.dialogueTree._normalizedOptionIndex=function(i){return i>=this.options.length&&(i=this.options.length-1),i<0&&(i=0),i},e.dialogueTree._cycledOptionIndex=function(i){return i>=this.options.length&&(i=0),i<0&&(i=this.options.length-1),i},e.dialogueTree.getLineOption=function(i){return!this.dialogueIsRunning||!this.options.length?[]:(i=e.dialogueTree._normalizedOptionIndex(i),this.options[i])},e.dialogueTree.getLineOptionsText=function(i,t){if(!this.dialogueIsRunning||!this.options.length)return"";let a="";return this.options.forEach(function(s,r){r===e.dialogueTree.selectedOption?a+=i:a+=i.replace(/.*/g," "),a+=s,t&&(a+=`
`)}),a},e.dialogueTree.getLineOptionsTextHorizontal=function(i){return this.getLineOptionsText(i,!1)},e.dialogueTree.getLineOptionsTextVertical=function(i){return this.getLineOptionsText(i,!0)},e.dialogueTree.getLineOptionsCount=function(){return this.dialogueIsRunning&&this.options.length?this.optionsCount:0},e.dialogueTree.confirmSelectOption=function(){if(!!this.dialogueIsRunning&&this.dialogueData.select&&!this.selectedOptionUpdated&&this.selectedOption!==-1){this.commandCalls=[];try{this.dialogueData.select(this.selectedOption);try{this.dialogueData=this.dialogue.next().value}catch(i){n.error("Error while confirming in the dialogue tree. Verify if there is a syntax error? Full error is: ",i);return}e.dialogueTree.goToNextDialogueLine()}catch(i){n.error("An error happened when trying to access the dialogue branch!",i)}}},e.dialogueTree.selectNextOption=function(){!this.dialogueIsRunning||this.dialogueData.select&&(this.selectedOption+=1,this.selectedOption=e.dialogueTree._cycledOptionIndex(this.selectedOption),this.selectedOptionUpdated=!0)},e.dialogueTree.selectPreviousOption=function(){!this.dialogueIsRunning||this.dialogueData.select&&(this.selectedOption-=1,this.selectedOption=e.dialogueTree._cycledOptionIndex(this.selectedOption),this.selectedOptionUpdated=!0)},e.dialogueTree.selectOption=function(i){!this.dialogueIsRunning||this.dialogueData.select&&(this.selectedOption=e.dialogueTree._normalizedOptionIndex(i),this.selectedOptionUpdated=!0)},e.dialogueTree.getSelectedOption=function(){if(!!this.dialogueIsRunning)return this.dialogueData.select?this.selectedOption:0},e.dialogueTree.hasSelectedOptionChanged=function(){return this.selectedOptionUpdated?(this.selectedOptionUpdated=!1,this.selectedOption===-1&&(this.selectedOption=0),!0):!1},e.dialogueTree.isDialogueLineType=function(i){if(!this.dialogueIsRunning)return!1;if(this.commandCalls&&i==="command"){if(this.commandCalls.some(function(t){return e.dialogueTree.clipTextEnd>t.time&&t.cmd==="wait"}))return!this.pauseScrolling;if(this.commandCalls.length>0&&this.commandParameters.length>0)return!0}return this.dialogueDataType===i},e.dialogueTree.hasDialogueBranch=function(i){return this.runner&&this.runner.yarnNodes&&Object.keys(this.runner.yarnNodes).some(function(t){return t===i})},e.dialogueTree.startFrom=function(i){if(this.runner=e.dialogueTree.runner,!!this.hasDialogueBranch(i)){this.optionsCount=0,this.options=[],this.tagParameters=[];try{this.dialogue=this.runner.run(i)}catch(t){n.error("Error while setting up the dialogue tree. Verify if there is a syntax error? Full error is: ",t);return}this.dialogueText="",this.clipTextEnd=0,this.commandCalls=[],this.commandParameters=[],this.pauseScrolling=!1;try{this.dialogueData=this.dialogue.next().value}catch(t){n.error("Error while starting the dialogue tree. Verify if there is a syntax error? Full error is: ",t);return}this.dialogueBranchTags=this.dialogueData.data.tags,this.dialogueBranchTitle=this.dialogueData.data.title,this.dialogueBranchBody=this.dialogueData.data.body,this.lineNum=this.dialogueData.lineNum,e.dialogueTree._isLineTypeText()?this.dialogueDataType="text":e.dialogueTree._isLineTypeOptions()?this.dialogueDataType="options":this.dialogueDataType="command",this.dialogueIsRunning=!0,e.dialogueTree.goToNextDialogueLine()}},e.dialogueTree._isLineTypeText=function(){return this.dialogueData instanceof bondage.TextResult},e.dialogueTree._isLineTypeOptions=function(){return this.dialogueData instanceof bondage.OptionsResult},e.dialogueTree._isLineTypeCommand=function(){return this.dialogueData instanceof bondage.CommandResult},e.dialogueTree.goToNextDialogueLine=function(){if(!(this.pauseScrolling||!this.dialogueIsRunning))if(this.optionsCount=0,this.selectedOption=-1,this.selectedOptionUpdated=!1,e.dialogueTree.getVariable("debug")&&n.info("Parsing:",this.dialogueData),!this.dialogueData)e.dialogueTree.stopRunningDialogue();else if(e.dialogueTree._isLineTypeText()){this.lineNum===this.dialogueData.lineNum&&this.dialogueBranchTitle===this.dialogueData.data.title?(this.clipTextEnd=this.dialogueText.length-1,this.dialogueText+=(this.dialogueText===""?"":" ")+this.dialogueData.text):(this.clipTextEnd=0,this.dialogueText=this.dialogueData.text),this.dialogueBranchTags=this.dialogueData.data.tags,this.dialogueBranchTitle=this.dialogueData.data.title,this.dialogueBranchBody=this.dialogueData.data.body,this.lineNum=this.dialogueData.lineNum,this.dialogueDataType="text";try{this.dialogueData=this.dialogue.next().value}catch(i){n.error("Error while progressing the dialogue tree. Verify if there is a syntax error? Full error is: ",i);return}}else if(e.dialogueTree._isLineTypeOptions())this.commandCalls=[],this.dialogueDataType="options",this.dialogueText="",this.clipTextEnd=0,this.optionsCount=this.dialogueData.options.length,this.options=this.dialogueData.options,this.selectedOptionUpdated=!0;else if(e.dialogueTree._isLineTypeCommand()){this.dialogueDataType="command";const i=this.dialogueData.text.split(" "),t=this.commandCalls.length&&this.commandCalls[this.commandCalls.length-1].cmd==="wait"?1:0;this.commandCalls.push({cmd:i[0],params:i,time:this.dialogueText.length+t});try{this.dialogueData=this.dialogue.next().value}catch(a){n.error("Error while progressing the dialogue tree. Verify if there is a syntax error? Full error is: ",a);return}e.dialogueTree.goToNextDialogueLine()}else this.dialogueDataType="unknown"},e.dialogueTree.getBranchTitle=function(){return this.dialogueIsRunning?this.dialogueBranchTitle:""},e.dialogueTree.branchTitleIs=function(i){return this.dialogueIsRunning?this.dialogueBranchTitle===i:!1},e.dialogueTree.getBranchTags=function(){return this.dialogueIsRunning?this.dialogueBranchTags.join(","):""},e.dialogueTree.getBranchTag=function(i){return this.dialogueIsRunning&&this.dialogueBranchTags.length?(i>this.dialogueBranchTags.length-1&&(i=this.dialogueBranchTags.length-1),this.dialogueBranchTags[i]):""},e.dialogueTree.branchContainsTag=function(i){return this.tagParameters=[],this.dialogueIsRunning&&this.dialogueBranchTags.length?this.dialogueBranchTags.some(function(t){const a=t.match(/([^\(]+)\(([^\)]+)\)/i);return e.dialogueTree.tagParameters=a?a[2].split(","):[],a?a[1]===i:t===i}):!1},e.dialogueTree.getTagParameter=function(i){if(this.dialogueIsRunning&&this.tagParameters.length>=i){const t=this.tagParameters[i];return t||""}return""},e.dialogueTree.getVisitedBranchTitles=function(){return this.dialogueIsRunning?Object.keys(this.runner.visited).join(","):""},e.dialogueTree.branchTitleHasBeenVisited=function(i){return i||(i=this.dialogueBranchTitle),Object.keys(this.runner.visited).includes(i)&&this.runner.visited[i]},e.dialogueTree.getBranchText=function(){return this.dialogueIsRunning?this.dialogueBranchBody:""},e.dialogueTree.getVariable=function(i){return this.runner.variables&&i in this.runner.variables.data?this.runner.variables.get(i):""},e.dialogueTree.getVariableAsNumber=function(i){if(this.runner.variables&&i in this.runner.variables.data){const t=this.runner.variables.get(i);return typeof t!="number"?parseFloat(t)||0:isFinite(t)?t:0}return 0},e.dialogueTree.getVariableAsString=function(i){return this.runner.variables&&i in this.runner.variables.data?""+this.runner.variables.get(i):""},e.dialogueTree.compareVariable=function(i,t){return this.runner.variables&&i in this.runner.variables.data?this.runner.variables.get(i)===t:!1},e.dialogueTree.setVariable=function(i,t){this.runner.variables&&this.runner.variables.set(i,t)},e.dialogueTree.saveState=function(i){const t={variables:e.dialogueTree.runner.variables.data,visited:e.dialogueTree.runner.visited};i.fromJSObject(t)},e.dialogueTree.loadState=function(i){const t=i.toJSObject();if(!t){n.error("Load state variable is empty:",i);return}try{e.dialogueTree.runner.visited=t.visited,e.dialogueTree.runner.variables.data={},Object.keys(t.variables).forEach(function(a){const s=t.variables[a];e.dialogueTree.runner.variables.set(a,s)})}catch(a){n.error("Failed to load state from variable:",i,a)}},e.dialogueTree.clearState=function(){e.dialogueTree.runner.visited={},e.dialogueTree.runner.variables.data={}}})(gdjs||(gdjs={}));
//# sourceMappingURL=dialoguetools.js.map
